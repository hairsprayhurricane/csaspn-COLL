@page
@model IndexModel
@{
    ViewData["Title"] = "localhost";
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <title>@ViewData["Title"]</title>
    <style>
        .file-upload {
            margin: 20px 0;
        }
        .file-info {
            margin: 10px 0;
            color: #666;
        }
        .error-message {
            color: red;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div>
        <p>@Html.Raw(Model.DeviceInfo?.Replace("\n", "<br />"))</p>
    </div>

    <div>
        <h2>Calorie Calculator</h2>
        <button type="button" onclick="location.href='/caloriecalc'">Go</button>
    </div>








    <div>
        <h2>Забронировать путешествие</h2>
        <button type="button" onclick="location.href='/addtrip'">Добавить путешествие</button>
    </div>

    <div class="file-upload">
        <h2>Загрузить изображение</h2>
        <form id="uploadForm" method="post" enctype="multipart/form-data">
            <input type="file" id="fileInput" name="file" accept=".jpg,.jpeg,.png,.gif" style="display: none;">
            <button type="button" onclick="document.getElementById('fileInput').click()">Выбрать файл</button>
            <div id="fileInfo" class="file-info">Файл не выбран</div>
            <div id="errorMessage" class="error-message"></div>
        </form>
    </div>

    <div class="time-checker">
        <h2>Получить привет (¯\_(ツ)_/¯)</h2>
        <button type="button" id="greetingButton">Получить привет</button>
    </div>
    
    <div class="random-getter">
        <h2>Случайное число: <span id="rndValue">Загрузка...</span></h2>
        <button type="button" id="refreshRnd">Обновить число</button>
    </div>

    <script>        
        // Server Image post
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const errorMessage = document.getElementById('errorMessage');
        const maxFileSize = 5 * 1024 * 1024; // 5MB
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            errorMessage.textContent = '';
            
            if (!file) {
                fileInfo.textContent = 'Файл не выбран';
                return;
            }

            if (!allowedTypes.includes(file.type)) {
                errorMessage.textContent = 'Недопустимый формат файла. Разрешены только: .jpg, .jpeg, .png, .gif';
                fileInput.value = '';
                fileInfo.textContent = 'Файл не выбран';
                return;
            }

            if (file.size > maxFileSize) {
                errorMessage.textContent = 'Размер файла превышает 5MB';
                fileInput.value = '';
                fileInfo.textContent = 'Файл не выбран';
                return;
            }

            fileInfo.textContent = `Выбран файл: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                let data;
                try {
                    data = responseText ? JSON.parse(responseText) : {};
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    throw new Error(`Ошибка обработки ответа сервера: ${responseText}`);
                }
                
                if (!response.ok) {
                    throw new Error(data.message || `Ошибка сервера: ${response.status} ${response.statusText}`);
                }
                
                if (data.success) {
                    alert(data.message || 'Файл успешно загружен!');
                    fileInput.value = '';
                    fileInfo.textContent = 'Файл не выбран';
                    errorMessage.textContent = '';
                } else {
                    throw new Error(data.message || 'Неизвестная ошибка сервера');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                const errorMsg = error.message || 'Произошла ошибка при загрузке файла';
                errorMessage.textContent = errorMsg;
                fileInput.value = '';
                fileInfo.textContent = 'Файл не выбран';
            });
        });


        // Hello button
        document.getElementById('greetingButton').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/greeting');
                if (!response.ok) {
                    throw new Error('Не удалось получить привет. Вижу ты его не заслужил.');
                }
                const data = await response.json();
                alert(data.greeting);
            } catch (error) {
                console.error('Error:', error);
                alert('Не удалось получить привет. Вижу ты его не заслужил.');
            }
        });
                // Update random number
        document.getElementById('refreshRnd').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/random');
                if (!response.ok) {
                    throw new Error('Не удалось получить случайное число');
                }
                const data = await response.json();
                document.getElementById('rndValue').textContent = data.number;
            } catch (error) {
                console.error('Error:', error);
                alert('Не удалось обновить число: ' + error.message);
            }
        });

        // Load random number on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('refreshRnd').click();
        });
    </script>
</body>
</html>
